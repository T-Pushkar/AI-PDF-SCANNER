<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Scanner Pro - Ultra Edition</title>
    
    <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; /* Indigo */
            --secondary: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --glass: rgba(30, 41, 59, 0.7);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Glass Header */
        header {
            padding: 15px;
            text-align: center;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }
        header h1 { 
            margin: 0; font-size: 1.2rem; font-weight: 700; 
            background: linear-gradient(to right, #818cf8, #34d399);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* Main Canvas / Preview */
        #viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            margin: 10px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
        }
        #imageToEdit { max-width: 100%; max-height: 100%; display: block; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Thumbnails Strip */
        .strip-container {
            background: var(--glass);
            padding: 10px 0;
            backdrop-filter: blur(10px);
        }
        .thumb-strip {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 0 15px;
            scrollbar-width: none;
        }
        .thumb-strip::-webkit-scrollbar { display: none; }
        
        .thumb-box {
            width: 65px; height: 85px;
            background: var(--card);
            border-radius: 12px;
            position: relative;
            flex-shrink: 0;
            border: 2px solid transparent;
            transition: 0.3s;
        }
        .thumb-box.active { border-color: var(--primary); transform: translateY(-5px) scale(1.05); }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
        .del-badge {
            position: absolute; top: -8px; right: -8px;
            background: var(--danger); color: white;
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; border: 2px solid var(--bg);
        }

        /* Action Sheet */
        .action-sheet {
            background: var(--card);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 20px 15px env(safe-area-inset-bottom);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            border-radius: 25px 25px 0 0;
        }

        .btn-action {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            background: none; border: none; color: #94a3b8; font-size: 0.75rem; font-weight: 500;
        }
        .btn-action .icon-box {
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: 0.2s;
        }
        .btn-action:active .icon-box { background: var(--primary); color: white; transform: scale(0.9); }

        .btn-main {
            grid-column: span 4;
            background: var(--primary); color: white;
            border-radius: 15px; padding: 16px;
            font-weight: 700; font-size: 1rem;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
            margin-top: 5px;
        }

        /* Camera Overlay */
        #cameraUI {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: none; flex-direction: column;
        }
        #video { flex: 1; object-fit: contain; }
        .cam-controls {
            padding: 40px; display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
        }
        .shutter {
            width: 75px; height: 75px; border-radius: 50%;
            background: white; border: 6px solid #333;
            box-shadow: 0 0 0 4px white;
        }

        /* Processing Loader */
        #loader {
            position: fixed; inset: 0; background: rgba(15,23,42,0.9);
            z-index: 2000; display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top: 15px; font-weight: 600;">Optimizing Image...</p>
</div>

<header>
    <h1>KASHYAP AI PDF SCANNER </h1>
</header>

<div id="viewport">
    <img id="imageToEdit" src="">
</div>

<div class="strip-container">
    <div class="thumb-strip" id="thumbStrip"></div>
</div>

<div class="action-sheet" id="mainMenu">
    <button class="btn-action" onclick="document.getElementById('multiFiles').click()">
        <div class="icon-box">📁</div><span>Import</span>
    </button>
    <button class="btn-action" id="btnCam">
        <div class="icon-box">📸</div><span>Camera</span>
    </button>
    <button class="btn-action" onclick="startCrop()">
        <div class="icon-box">✂️</div><span>Crop</span>
    </button>
    <button class="btn-action" onclick="manualRefilter()">
        <div class="icon-box">✨</div><span>Scan</span>
    </button>
    <button class="btn-action" onclick="rotateImage()">
        <div class="icon-box">🔄</div><span>Rotate</span>
    </button>
    <button class="btn-action" onclick="restoreOriginal()">
        <div class="icon-box">🔙</div><span>Original</span>
    </button>
    
    <input type="file" id="multiFiles" accept="image/*" multiple hidden>
    
    <button class="btn-main" id="btnSavePDF" onclick="exportPDF()" style="display:none;">💾 SAVE PDF</button>
</div>

<div class="action-sheet" id="cropMenu" style="display:none; grid-template-columns: 1fr 1fr;">
    <button class="btn-action btn-main" style="background:var(--success)" onclick="applyCrop()">✅ Apply Changes</button>
    <button class="btn-action btn-main" style="background:var(--danger)" onclick="cancelCrop()">❌ Cancel</button>
</div>

<div id="cameraUI">
    <video id="video" autoplay playsinline></video>
    <div class="cam-controls">
        <button onclick="stopCamera()" style="background:none; color:white; border:none; font-size: 1rem;">Close</button>
        <button class="shutter" onclick="captureSnapshot()"></button>
        <div style="width:50px"></div>
    </div>
</div>

<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    let images = []; 
    let currentIndex = -1;
    let cropper = null;
    const imgEl = document.getElementById('imageToEdit');
    const hCanv = document.getElementById('hiddenCanvas');
    let cvReady = false;

    // Load OpenCV
    window.onload = () => {
        let check = setInterval(() => {
            if (typeof cv !== 'undefined' && cv.Mat) { cvReady = true; clearInterval(check); }
        }, 500);
    };

    // --- Data Handlers ---
    document.getElementById('multiFiles').onchange = async (e) => {
        const files = Array.from(e.target.files);
        if(!files.length) return;
        setLoader(true);
        for (const f of files) {
            const data = await new Promise(r => {
                const rd = new FileReader(); rd.onload = (ev) => r(ev.target.result); rd.readAsDataURL(f);
            });
            await processNewImage(data);
        }
        setLoader(false);
        refreshUI();
        selectImage(images.length - 1);
    };

    async function processNewImage(src) {
        return new Promise((resolve) => {
            const i = new Image();
            i.onload = () => {
                if(!cvReady) { images.push({current: src, original: src}); resolve(); return; }
                let m = cv.imread(i);
                cv.cvtColor(m, m, cv.COLOR_RGBA2GRAY);
                cv.adaptiveThreshold(m, m, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 15);
                cv.imshow(hCanv, m);
                images.push({current: hCanv.toDataURL('image/jpeg', 0.85), original: src});
                m.delete(); resolve();
            };
            i.src = src;
        });
    }

    function refreshUI() {
        const strip = document.getElementById('thumbStrip');
        strip.innerHTML = '';
        images.forEach((img, idx) => {
            const div = document.createElement('div');
            div.className = `thumb-box ${idx === currentIndex ? 'active' : ''}`;
            div.innerHTML = `<img src="${img.current}" onclick="selectImage(${idx})">
                             <div class="del-badge" onclick="deleteImg(${idx}, event)">✕</div>`;
            strip.appendChild(div);
        });
        document.getElementById('btnSavePDF').style.display = images.length ? 'block' : 'none';
    }

    function selectImage(idx) {
        if(idx < 0 || idx >= images.length) return;
        if(cropper) cancelCrop();
        currentIndex = idx;
        imgEl.src = images[idx].current;
        refreshUI();
    }

    function deleteImg(idx, e) {
        e.stopPropagation();
        images.splice(idx, 1);
        if(!images.length) { imgEl.src = ""; currentIndex = -1; }
        else { selectImage(Math.max(0, currentIndex - 1)); }
        refreshUI();
    }

    // --- Tools ---
    function startCrop() {
        if(!imgEl.src) return;
        cropper = new Cropper(imgEl, { viewMode: 1, background: false });
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('cropMenu').style.display = 'grid';
    }

    function cancelCrop() {
        if(cropper) { cropper.destroy(); cropper = null; }
        document.getElementById('mainMenu').style.display = 'grid';
        document.getElementById('cropMenu').style.display = 'none';
        imgEl.src = images[currentIndex].current;
    }

    function applyCrop() {
        images[currentIndex].current = cropper.getCroppedCanvas().toDataURL('image/jpeg', 0.9);
        cancelCrop();
        refreshUI();
    }

    function rotateImage() {
        if(currentIndex < 0) return;
        const i = new Image();
        i.onload = () => {
            let s = cv.imread(i); let d = new cv.Mat();
            cv.rotate(s, d, cv.ROTATE_90_CLOCKWISE);
            cv.imshow(hCanv, d);
            images[currentIndex].current = hCanv.toDataURL('image/jpeg', 0.9);
            imgEl.src = images[currentIndex].current;
            s.delete(); d.delete(); refreshUI();
        };
        i.src = imgEl.src;
    }

    function manualRefilter() {
        if(currentIndex < 0) return;
        setLoader(true);
        const i = new Image();
        i.onload = () => {
            let m = cv.imread(i);
            cv.cvtColor(m, m, cv.COLOR_RGBA2GRAY);
            cv.adaptiveThreshold(m, m, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 15);
            cv.imshow(hCanv, m);
            images[currentIndex].current = hCanv.toDataURL('image/jpeg', 0.85);
            imgEl.src = images[currentIndex].current;
            m.delete(); setLoader(false); refreshUI();
        };
        i.src = images[currentIndex].current;
    }

    function restoreOriginal() {
        if(currentIndex < 0) return;
        images[currentIndex].current = images[currentIndex].original;
        imgEl.src = images[currentIndex].original;
        refreshUI();
    }

    // --- Camera ---
    document.getElementById('btnCam').onclick = async () => {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('video').srcObject = s;
            document.getElementById('cameraUI').style.display = 'flex';
        } catch(e) { alert("Camera Error"); }
    };

    function stopCamera() {
        const s = document.getElementById('video').srcObject;
        if(s) s.getTracks().forEach(t => t.stop());
        document.getElementById('cameraUI').style.display = 'none';
    }

    async function captureSnapshot() {
        const v = document.getElementById('video');
        hCanv.width = v.videoWidth; hCanv.height = v.videoHeight;
        hCanv.getContext('2d').drawImage(v, 0, 0);
        const data = hCanv.toDataURL('image/jpeg', 0.9);
        stopCamera();
        setLoader(true);
        await processNewImage(data);
        setLoader(false); refreshUI(); selectImage(images.length - 1);
    }

    function setLoader(val) { document.getElementById('loader').style.display = val ? 'flex' : 'none'; }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        for (let i = 0; i < images.length; i++) {
            if(i > 0) doc.addPage();
            doc.addImage(images[i].current, 'JPEG', 10, 10, 190, 270);
        }
        doc.save(`Scan_${new Date().toLocaleDateString().replace(/\//g,'-')}.pdf`);
    }
</script>
</body>
</html>