<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, 

maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kashyap AI Scanner Pro</title>
    
    <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
    <script 

src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></s

cript>
    <link rel="stylesheet" 

href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css

">
    <script 

src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js">

</script>

    <style>
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; 

}
        body { font-family: 'Inter', sans-serif; background: var(--bg); 

color: var(--text); margin: 0; height: 100dvh; display: flex; flex-direction: 

column; overflow: hidden; }

        header { padding: 8px; text-align: center; background: var(--card); 

border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
        header h1 { margin: 0; font-size: 0.85rem; letter-spacing: 1px; 

color: #818cf8; text-transform: uppercase; }

        #viewport { flex: 1; display: flex; align-items: center; justify-

content: center; background: #000; margin: 5px; border-radius: 12px; 

overflow: hidden; position: relative; }
        #imageToEdit { max-width: 100%; max-height: 100%; object-fit: 

contain; transition: filter 0.1s ease; }

        #btnSavePDF { position: absolute; bottom: 20px; right: 20px; width: 

60px; height: 60px; background: var(--success); color: white; border-radius: 

50%; display: none; align-items: center; justify-content: center; font-size: 

1.5rem; border: none; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-

index: 100; cursor: pointer; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY

(0);} 40% {transform: translateY(-5px);} }

        #scanAdjustMenu {
            position: absolute; bottom: 0; left: 0; right: 0; background: 

rgba(30, 41, 59, 0.98);
            padding: 20px; display: none; flex-direction: column; gap: 10px; 

border-radius: 20px 20px 0 0; z-index: 150; box-shadow: 0 -5px 20px rgba

(0,0,0,0.5);
        }
        .slider-label { display: flex; justify-content: space-between; font-

size: 0.8rem; color: #94a3b8; margin-bottom: 4px; }
        input[type=range] { width: 100%; height: 6px; background: #334155; 

border-radius: 5px; outline: none; -webkit-appearance: none; margin-bottom: 

12px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; 

width: 22px; height: 22px; background: var(--primary); border-radius: 50%; 

cursor: pointer; border: 2px solid white; }

        .strip-container { background: #000; padding: 5px 0; flex-shrink: 0; 

}
        .thumb-strip { display: flex; overflow-x: auto; gap: 12px; padding: 

5px 15px; scrollbar-width: none; }
        .thumb-box { width: 50px; height: 65px; background: var(--card); 

border-radius: 6px; position: relative; flex-shrink: 0; border: 2px solid 

transparent; }
        .thumb-box.active { border-color: var(--primary); }
        .thumb-box img { width: 100%; height: 100%; object-fit: cover; 

border-radius: 4px; }
        .del-badge { position: absolute; top: -8px; right: -8px; background: 

var(--danger); color: white; width: 20px; height: 20px; border-radius: 50%; 

display: flex; align-items: center; justify-content: center; font-size: 12px; 

font-weight: bold; border: 2px solid #000; z-index: 10; }

        .action-sheet { background: var(--card); display: flex; overflow-x: 

auto; padding: 12px 10px calc(12px + env(safe-area-inset-bottom)); gap: 10px; 

border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; scrollbar-width: 

none; }
        .btn-action { display: flex; flex-direction: column; align-items: 

center; min-width: 65px; background: none; border: none; color: #94a3b8; 

font-size: 0.65rem; cursor: pointer; }
        .btn-action .icon-box { width: 44px; height: 44px; background: rgba

(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; 

justify-content: center; font-size: 1.2rem; margin-bottom: 4px; }

        #cameraUI { position: fixed; inset: 0; background: #000; z-index: 

1000; display: none; flex-direction: column; }
        #video { width: 100%; height: 80%; object-fit: contain; }
        .cam-controls { flex: 1; display: flex; align-items: center; 

justify-content: space-around; background: #000; }
        .shutter { width: 65px; height: 65px; border-radius: 50%; background: 

white; border: 5px solid #333; }
        .crop-confirm-box { position: absolute; bottom: 20px; left: 0; right: 

0; display: flex; justify-content: center; gap: 15px; z-index: 110; }
        .btn-crop { padding: 10px 25px; border-radius: 8px; border: none; 

color: white; font-weight: bold; font-size: 0.9rem; }
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-

index: 2000; display: none; flex-direction: column; align-items: center; 

justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba

(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; 

animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>
<header><h1>Kashyap Scanner Pro</h1></header>

<div id="viewport">
    <img id="imageToEdit" src="">
    <button id="btnSavePDF" onclick="exportPDF()" title="Save PDF">üíæ</button>

    <div id="scanAdjustMenu">
        <div>
            <div class="slider-label"><span>Brightness</span><span 

id="bVal">100%</span></div>
            <input type="range" id="brightnessScale" min="50" max="150" 

value="100" oninput="liveAdjustAI()">
        </div>
        <div>
            <div class="slider-label"><span>Contrast</span><span 

id="cVal">100%</span></div>
            <input type="range" id="contrastScale" min="50" max="200" 

value="100" oninput="liveAdjustAI()">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <button class="btn-crop" style="background:var(--success); 

flex:1" onclick="applyAIScan()">Apply</button>
            <button class="btn-crop" style="background:var(--danger); flex:1" 

onclick="closeAIScan()">Cancel</button>
        </div>
    </div>

    <div id="cropMenu" class="crop-confirm-box" style="display:none;">
        <button class="btn-crop" style="background:var(--success)" 

onclick="applyCrop()">‚úÖ Apply</button>
        <button class="btn-crop" style="background:var(--danger)" 

onclick="cancelCrop()">‚ùå Cancel</button>
    </div>
</div>

<div class="strip-container"><div class="thumb-strip" 

id="thumbStrip"></div></div>

<div class="action-sheet" id="mainMenu">
    <button class="btn-action" onclick="document.getElementById

('multiFiles').click()"><div class="icon-box">üìÅ

</div><span>Import</span></button>
    <button class="btn-action" id="btnCam"><div class="icon-box">üì∏

</div><span>Camera</span></button>
    <button class="btn-action" onclick="startCrop()"><div class="icon-

box">‚úÇÔ∏è</div><span>Crop</span></button>
    <button class="btn-action" onclick="openAIScanMenu()"><div class="icon-

box" style="background:var(--primary); color:white;">‚ú®</div><span>Scan 

AI</span></button>
    <button class="btn-action" onclick="rotateImage()"><div class="icon-

box">üîÑ</div><span>Rotate</span></button>
    <button class="btn-action" onclick="deleteCurrentImg()"><div 

class="icon-box" style="color:var(--danger)">üóëÔ∏è

</div><span>Delete</span></button>
    <button class="btn-action" onclick="restoreOriginal()"><div class="icon-

box">üîô</div><span>Reset</span></button>
    <button class="btn-action" onclick="location.reload()"><div class="icon-

box">üßπ</div><span>Clear All</span></button>
    <input type="file" id="multiFiles" accept="image/*" multiple hidden>
</div>

<div id="cameraUI">
    <video id="video" autoplay playsinline></video>
    <div class="cam-controls">
        <button onclick="stopCamera()" style="color:white; background:none; 

border:none;">Close</button>
        <button class="shutter" onclick="captureSnapshot()"></button>
        <div style="width:40px"></div>
    </div>
</div>

<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    let images = []; let currentIndex = -1; let cropper = null;
    const imgEl = document.getElementById('imageToEdit');
    const hCanv = document.getElementById('hiddenCanvas');
    const saveBtn = document.getElementById('btnSavePDF');
    const aiMenu = document.getElementById('scanAdjustMenu');
    let cvReady = false;

    window.onload = () => {
        let check = setInterval(() => { if (typeof cv !== 'undefined' && 

cv.Mat) { cvReady = true; clearInterval(check); } }, 500);
    };

    document.getElementById('multiFiles').onchange = async (e) => {
        const files = Array.from(e.target.files);
        if(!files.length) return;
        setLoader(true);
        for (const f of files) {
            const data = await new Promise(r => { const rd = new FileReader

(); rd.onload = (ev) => r(ev.target.result); rd.readAsDataURL(f); });
            await processNewImage(data);
        }
        setLoader(false); refreshUI(); selectImage(images.length - 1);
    };

    // --- AUTO SCAN ON UPLOAD ---
    async function processNewImage(src) {
        return new Promise((resolve) => {
            const i = new Image();
            i.onload = () => {
                if(!cvReady) { 
                    images.push({current: src, original: src}); 
                    resolve(); return; 
                }
                // Automatic OpenCV Scan
                let m = cv.imread(i);
                cv.cvtColor(m, m, cv.COLOR_RGBA2GRAY);
                cv.adaptiveThreshold(m, m, 255, 

cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 21, 15);
                cv.imshow(hCanv, m);
                images.push({current: hCanv.toDataURL('image/jpeg', 0.85), 

original: src});
                m.delete(); resolve();
            };
            i.src = src;
        });
    }

    // --- SCAN AI ADJUSTER (RESET TO ORIGINAL + SLIDERS) ---
    function openAIScanMenu() {
        if(currentIndex < 0) return;
        
        // Click karte hi original image par switch karna
        imgEl.src = images[currentIndex].original;
        imgEl.style.filter = "none";
        
        // Reset Sliders to default 100%
        document.getElementById('brightnessScale').value = 100;
        document.getElementById('contrastScale').value = 100;
        document.getElementById('bVal').innerText = "100%";
        document.getElementById('cVal').innerText = "100%";

        aiMenu.style.display = 'flex';
        saveBtn.style.visibility = 'hidden';
    }

    function liveAdjustAI() {
        const b = document.getElementById('brightnessScale').value;
        const c = document.getElementById('contrastScale').value;
        document.getElementById('bVal').innerText = b + "%";
        document.getElementById('cVal').innerText = c + "%";
        // Real-time CSS preview on original image
        imgEl.style.filter = `brightness(${b}%) contrast(${c}%)`;
    }

    function applyAIScan() {
        const b = document.getElementById('brightnessScale').value;
        const c = document.getElementById('contrastScale').value;
        const i = new Image();
        i.onload = () => {
            hCanv.width = i.width;
            hCanv.height = i.height;
            const ctx = hCanv.getContext('2d');
            ctx.filter = `brightness(${b}%) contrast(${c}%)`;
            ctx.drawImage(i, 0, 0);
            images[currentIndex].current = hCanv.toDataURL('image/jpeg', 

0.9);
            imgEl.style.filter = "none";
            refreshUI();
            closeAIScan();
        };
        i.src = images[currentIndex].original;
    }

    function closeAIScan() {
        aiMenu.style.display = 'none';
        saveBtn.style.visibility = 'visible';
        imgEl.style.filter = "none";
        imgEl.src = images[currentIndex].current;
    }

    // --- BAKI CORE FUNCTIONS ---
    function refreshUI() {
        const strip = document.getElementById('thumbStrip');
        strip.innerHTML = '';
        images.forEach((img, idx) => {
            const div = document.createElement('div');
            div.className = `thumb-box ${idx === currentIndex ? 'active' : 

''}`;
            div.innerHTML = `<img src="${img.current}" onclick="selectImage

(${idx})"><div class="del-badge" onclick="deleteImg(${idx}, event)">‚úï</div>`;
            strip.appendChild(div);
        });
        saveBtn.style.display = images.length ? 'flex' : 'none';
    }

    function selectImage(idx) {
        if(idx < 0 || idx >= images.length) return;
        if(cropper) cancelCrop();
        currentIndex = idx;
        imgEl.src = images[idx].current;
        refreshUI();
    }

    function deleteImg(idx, e) {
        if(e) e.stopPropagation();
        images.splice(idx, 1);
        if(!images.length) { imgEl.src = ""; currentIndex = -1; }
        else { selectImage(Math.max(0, currentIndex - 1)); }
        refreshUI();
    }

    function deleteCurrentImg() { if(currentIndex >= 0) deleteImg

(currentIndex); }

    function startCrop() {
        if(!imgEl.src) return;
        cropper = new Cropper(imgEl, { viewMode: 1, background: false });
        document.getElementById('mainMenu').style.visibility = 'hidden';
        saveBtn.style.visibility = 'hidden';
        document.getElementById('cropMenu').style.display = 'flex';
    }

    function cancelCrop() {
        if(cropper) { cropper.destroy(); cropper = null; }
        document.getElementById('mainMenu').style.visibility = 'visible';
        saveBtn.style.visibility = 'visible';
        document.getElementById('cropMenu').style.display = 'none';
        imgEl.src = images[currentIndex].current;
    }

    function applyCrop() {
        images[currentIndex].current = cropper.getCroppedCanvas().toDataURL

('image/jpeg', 0.9);
        images[currentIndex].original = images[currentIndex].current; 
        cancelCrop(); refreshUI();
    }

    function rotateImage() {
        if(currentIndex < 0) return;
        const i = new Image();
        i.onload = () => {
            let s = cv.imread(i); let d = new cv.Mat();
            cv.rotate(s, d, cv.ROTATE_90_CLOCKWISE);
            cv.imshow(hCanv, d);
            images[currentIndex].current = hCanv.toDataURL('image/jpeg', 

0.9);
            images[currentIndex].original = images[currentIndex].current; 
            imgEl.src = images[currentIndex].current;
            s.delete(); d.delete(); refreshUI();
        };
        i.src = imgEl.src;
    }

    function restoreOriginal() {
        if(currentIndex < 0) return;
        images[currentIndex].current = images[currentIndex].original;
        imgEl.src = images[currentIndex].original;
        refreshUI();
    }

    document.getElementById('btnCam').onclick = async () => {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { 

facingMode: "environment" } });
            document.getElementById('video').srcObject = s;
            document.getElementById('cameraUI').style.display = 'flex';
        } catch(e) { alert("Camera Error"); }
    };

    function stopCamera() {
        const s = document.getElementById('video').srcObject;
        if(s) s.getTracks().forEach(t => t.stop());
        document.getElementById('cameraUI').style.display = 'none';
    }

    async function captureSnapshot() {
        const v = document.getElementById('video');
        hCanv.width = v.videoWidth; hCanv.height = v.videoHeight;
        hCanv.getContext('2d').drawImage(v, 0, 0);
        const data = hCanv.toDataURL('image/jpeg', 0.9);
        stopCamera();
        setLoader(true);
        await processNewImage(data);
        setLoader(false); refreshUI(); selectImage(images.length - 1);
    }

    function setLoader(val) { document.getElementById('loader').style.display 

= val ? 'flex' : 'none'; }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
       

 const doc = new jsPDF();
        
        // Date aur Time nikalne ke liye 

logic
        const now = new Date();
        const dateStr = 

now.toLocaleDateString('en-GB').replace(/\//g, '-'); // Format: DD-MM-YYYY
    

    const timeStr = now.toLocaleTimeString('en-GB').replace(/:/g, '-'); // 

Format: HH-MM-SS
        const fileName = `Today_Scan_${dateStr}_

${timeStr}.pdf`;

        setLoader(true); // Loader dikhayein kyunki PDF 

processing mein time lag sakta hai

        for (let i = 0; i < images.length; 

i++) {
            if(i > 0) doc.addPage();
            
            // Image ko 

PDF mein add karna
            // 10, 10 margin hai aur 190, 270 width/height 

hai
            doc.addImage(images[i].current, 'JPEG', 10, 10, 190, 270);
     

   }

        doc.save(fileName);
        setLoader(false);
    }
</script>
</body>
</html>
